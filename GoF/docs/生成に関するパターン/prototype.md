# Prototype

## 概要

ディープコピーで複製したオブジェクトたち

newするのにはものすっごい費用がかかるとまず認識する.

例えば、「計算結果」というプロパティオブジェクトを考える

これは引数xを指定するとxについて足したりかけたりなんじゃかんじゃと難しい計算をして

その挙句5とか3とかのシンプルな整数をその計算の解として持つ。

そのオブジェクトを引数2としてnewするとクソ長い計算の果てに計算結果= 4を得るとする。

このオブジェクトがもう一つ欲しくなった時、再びnewするとクソ長い計算がまた始まる。

それより、演算結果がすでにわかったのだから、計算結果に4を持つ同じインスタンスをnewせず複製すれば一瞬で終わる話。

生成したらやりっぱなし放置しておけるインスタンスに使えるパターン。

必要条件は

- ミュータブルであること
- 互いに異なるオブジェクトであること

イミュータブルならそれはグローバル変数だし
ミュータブルでも互いに同じならそれは同じ動きしかできない。棒の両端にマネキンつけるアレ。

## メリット(用途)

インスタンス生成における以下のような事例

1. オブジェクトの種類が多すぎてクラスにまとめられないとき
   - 図形作成オブジェクトとして、その気になれば図形の種類に応じていくらでもクラスファイルが生成しうる場合
2. クラスからのインスタンス生成が難しいとき
   - めちゃくちゃ複雑な過程から生成されたインスタンスが複数必要なら、一つ作ったものを保存しておいてコピーする
3. フレームワークと生成するインスタンスを分離したいとき

コピー機は元の書類をどうやって作ったか知らなくても、コピーをかければ同じ書類を何枚でも作れる

## やり方

1. コピーしたいクラスにディープコピーするメソッドを用意
   - Javaなら`java.lang.Clonable`を実装して`clone()`
     - ただし**cloneはシャローコピー**であり、例えば配列プロパティは参照だけがコピーされるので、**クローン元の配列プロパティを書き換えるとクローン先も書き換わる**ため、適宜ディープコピーをオーバーライド

## 関連

- Flyweight
  - Prototypeでは現在インスタンスを複製
  - Flyweightでは一つのインスタンスを複数位置で共有
- Memento
  - Prototypeでは現在のインスタンスと同じ状態のインスタンスを別インスタンス生成
  - Mementoではスナップショットとアンドゥを行うためにために現在のインスタンス状態を保存
- CompositeとDecorator
  - これらの使用時、インスタンス生成が複雑になりがちなのでPrototypeで複製すると美味しい
- Command
  - 命令を複数生成するときにPrototypeが用いられることがある

## ソース

### Java

[include](../../patterns/dpsrc_2009-10-10/src/Prototype/Sample/MessageBox.java)
[include](../../patterns/dpsrc_2009-10-10/src/Prototype/Sample/framework/Product.java)
[include](../../patterns/dpsrc_2009-10-10/src/Prototype/Sample/framework/Manager.java)
[include](../../patterns/dpsrc_2009-10-10/src/Prototype/Sample/UnderlinePen.java)
[include](../../patterns/dpsrc_2009-10-10/src/Prototype/Sample/Main.java)

### PHP

[include](../../patterns/Prototype/index.php)
